using UnityEngine;
using SlimeKing.Gameplay;

/// <summary>
/// Controla interações com elementos do ambiente que reagem à presença 
/// do jogador ou criaturas, como grama balançando ou água ondulando.
/// </summary>
public class EnvironmentInteractable : Interactable, IDamageable
{
    [Header("Health Settings")]
    [Tooltip("Pontos de vida/resistência inicial do objeto")]
    [SerializeField] private float maxHealth = 1f;

    [Header("Visual Settings")]
    [Tooltip("Animator que controla o efeito visual")]
    [SerializeField] private Animator animator;

    [Tooltip("Tag das entidades que podem ativar o efeito")]
    [SerializeField] private string[] interactableTags = { "Player", "Creature" };    [Header("Destruction Settings")]
    [Tooltip("Se verdadeiro, o objeto pode ser destruído após receber dano")]
    [SerializeField] private bool isDestructible = false;

    [Tooltip("Quantidade de hits necessários para destruir o objeto")]
    [SerializeField, Min(1)] private int resistance = 1;

    [Header("Drop Settings")]
    [Tooltip("Chance de dropar um item ao ser destruído (0-100%)")]
    [SerializeField, Range(0, 100)] private float dropChance = 20f;

    [Tooltip("Lista de prefabs que podem ser dropados")]
    [SerializeField] private GameObject[] possibleDrops;

    [Tooltip("Quantidade máxima de itens que podem ser dropados")]
    [SerializeField, Min(1)] private int maxDropCount = 1;

    [Header("Hit Effect")]
    [Tooltip("Efeito visual instanciado ao receber dano")]
    [SerializeField] private GameObject hitEffectPrefab;

    [Header("Audio Settings")]
    [Tooltip("Som reproduzido durante a interação")]
    [SerializeField] private AudioClip interactionSound;
    [Tooltip("Volume do som")]
    [Range(0, 1)]
    [SerializeField] private float volume = 0.5f; private AudioSource audioSource;
    private float lastEffectTime;
    private int currentHits = 0;
    private float currentHealth;
    private static readonly int IsShaking = Animator.StringToHash("Shake");
    private static readonly int IsDestroying = Animator.StringToHash("Destroy");

    private GameObject particleObject;

    public float CurrentHealth => currentHealth;
    public float MaxHealth => maxHealth; private void Awake()
    {
        // Get or add required components
        if (animator == null) animator = GetComponent<Animator>();

        // Cache particles reference
        particleObject = transform.Find("particulas")?.gameObject;

        if (interactionSound != null)
        {
            audioSource = gameObject.AddComponent<AudioSource>();
            audioSource.clip = interactionSound;
            audioSource.volume = volume;
            audioSource.spatialBlend = 1f; // 3D sound
            audioSource.playOnAwake = false;
        }

        // Inicializa a vida
        currentHealth = maxHealth;
    }

    /// <summary>
    /// Destroi este objeto imediatamente
    /// </summary>
    public void DestroyObject()
    {
        Destroy(gameObject);
    }


    private void OnTriggerEnter2D(Collider2D other)
    {
        if (IsValidInteractor(other.tag))
        {
            TriggerShake();
        }
    }

    private bool IsValidInteractor(string tag)
    {
        return System.Array.Exists(interactableTags, t => t == tag);
    }
    private void TriggerShake()
    {
        // Trigger shake animation
        if (animator != null)
        {
            animator.SetTrigger(IsShaking);
        }

        // Activate particles
        if (particleObject != null)
        {
            particleObject.SetActive(true);
        }

        // Play sound if configured
        if (audioSource != null && interactionSound != null)
        {
            audioSource.Play();
        }

    }

    /// <summary>
    /// Inicia a animação de destruição do objeto
    /// </summary>    public void TriggerDestroy()
    {
        // Tenta dropar itens antes de iniciar a destruição
        SpawnDrops();

        if (animator != null)
        {
            animator.SetTrigger(IsDestroying);

            // Activate particles
            if (particleObject != null)
            {
                particleObject.SetActive(true);
            }

            // Play sound if configured
            if (audioSource != null && interactionSound != null)
            {
                audioSource.Play();
            }
        }
        else
        {
            // If no animator, destroy immediately
            Destroy(gameObject);
        }
    }

    protected override void ShowVisualFeedback()
    {
        // Optional: Add highlight or other visual cue when player is near
    }

    protected override void HideVisualFeedback()
    {
        // Optional: Remove highlight or visual cue
    }

    public override void Interact()
    {
        // This type auto-interacts on collision, no manual interaction needed
    }    public bool TakeDamage(float damage, GameObject source = null)
    {
        if (currentHealth <= 0) return false;

        currentHealth = Mathf.Max(0, currentHealth - damage);

        // Spawna efeito de hit na posição do impacto
        SpawnHitEffect(transform.position);

        // Sempre mostra feedback visual ao tomar dano
        TriggerShake();

        // Se perdeu toda a vida, inicia a destruição
        if (currentHealth <= 0)
        {
            TriggerDestroy();
            return true;
        }

        return true;
    }

    private void SpawnDrops()
    {
        if (possibleDrops == null || possibleDrops.Length == 0) return;

        // Verifica se deve dropar baseado na chance configurada
        if (Random.Range(0f, 100f) > dropChance) return;

        // Decide quantos itens serão dropados
        int dropCount = Random.Range(1, maxDropCount + 1);

        for (int i = 0; i < dropCount; i++)
        {
            // Escolhe um item aleatório da lista
            GameObject dropPrefab = possibleDrops[Random.Range(0, possibleDrops.Length)];
            if (dropPrefab == null) continue;

            // Calcula uma posição aleatória próxima ao objeto
            Vector2 randomOffset = Random.insideUnitCircle * 0.5f;
            Vector3 dropPosition = transform.position + new Vector3(randomOffset.x, randomOffset.y, 0);

            // Instancia o item
            Instantiate(dropPrefab, dropPosition, Quaternion.identity);
        }
    }

    private void SpawnHitEffect(Vector3 hitPosition)
    {
        if (hitEffectPrefab != null)
        {
            GameObject effect = Instantiate(hitEffectPrefab, hitPosition, Quaternion.identity);
            
            // Opcionalmente, destruir o efeito após um tempo
            Destroy(effect, 2f);
        }
    }
}